generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String               @id @default(uuid())
  email         String               @unique
  name          String?
  passwordHash  String?
  roles         Role[]
  verifiedAt    DateTime?
  avatarUrl     String?
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt
  actorProfile  ActorProfile?
  agentProfile  AgentProfile?
  articles      Article[]
  auditLogs     AuditLog[]
  applications  CastingApplication[]
  certificates  Certificate[]
  crewProfile   CrewProfile?
  messagesSent  Message[]            @relation("MessagesSent")
  notifications Notification[]
  payments      Payment[]
  proProfile    ProProfile?
  subscriptions Subscription[]
  progress      UserProgress[]
  quizAttempts  UserQuizAttempt[]
}

model ActorProfile {
  id                String        @id @default(uuid())
  userId            String        @unique
  photo             String?
  galerie           String[]
  bio               String?
  age               Int?
  taille            Int?
  langues           String[]
  ville             String?
  competences       String[]
  experiences       Json?
  demoVideoId       String?
  cvUrl             String?
  completenessScore Int           @default(0)
  status            ProfileStatus @default(DRAFT)
  isVerified        Boolean       @default(false)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  agentId           String?
  agent             AgentProfile? @relation(fields: [agentId], references: [id])
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  films             Film[]        @relation("FilmActors")
  endorsements      Endorsement[]
}

model CrewProfile {
  id           String   @id @default(uuid())
  userId       String   @unique
  photo        String?
  bio          String?
  professions  String[]
  experiences  Json?
  portfolioUrl String?
  cvUrl        String?
  isVerified   Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  films        Film[]   @relation("FilmCrew")
}

model AgentProfile {
  id         String         @id @default(uuid())
  userId     String         @unique
  agencyName String
  bio        String?
  logoUrl    String?
  siteWeb    String?
  isVerified Boolean        @default(false)
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt
  talents    ActorProfile[]
  user       User           @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model ProProfile {
  id           String        @id @default(uuid())
  userId       String        @unique
  companyName  String
  siret        String?
  siteWeb      String?
  isVerified   Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  castings     Casting[]
  documents    Document[]
  endorsements Endorsement[]
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Casting {
  id           String               @id @default(uuid())
  proId        String
  titre        String
  projet       String
  dates        String
  lieu         String
  roles        Json
  criteres     String?
  remuneration String?
  deadline     DateTime
  status       CastingStatus        @default(DRAFT)
  publishedAt  DateTime?
  createdAt    DateTime             @default(now())
  updatedAt    DateTime             @updatedAt
  proProfile   ProProfile           @relation(fields: [proId], references: [id], onDelete: Cascade)
  applications CastingApplication[]
  documents    Document[]
  messages     Message[]
}

model Document {
  id            String              @id @default(uuid())
  proId         String
  castingId     String?
  applicationId String?
  titre         String
  type          String
  pdfUrl        String?
  status        String              @default("DRAFT")
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
  application   CastingApplication? @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  casting       Casting?            @relation(fields: [castingId], references: [id], onDelete: Cascade)
  pro           ProProfile          @relation(fields: [proId], references: [id], onDelete: Cascade)
}

model CastingApplication {
  id           String            @id @default(uuid())
  castingId    String
  actorId      String
  message      String?
  pieces       String[]
  status       ApplicationStatus @default(PENDING)
  notes        String?
  selftapeUrl  String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  actor        User              @relation(fields: [actorId], references: [id], onDelete: Cascade)
  casting      Casting           @relation(fields: [castingId], references: [id], onDelete: Cascade)
  documents    Document[]
  auditionSlot AuditionSlot?

  @@unique([castingId, actorId])
}

model AuditionSlot {
  id            String             @id @default(uuid())
  applicationId String             @unique
  date          DateTime
  dureeMinutes  Int                @default(15)
  lieu          String?
  notes         String?
  createdAt     DateTime           @default(now())
  application   CastingApplication @relation(fields: [applicationId], references: [id], onDelete: Cascade)
}

model Endorsement {
  id             String        @id @default(uuid())
  proId          String
  actorProfileId String
  rating         Int           @default(5)
  comment        String?
  createdAt      DateTime      @default(now())
  pro            ProProfile    @relation(fields: [proId], references: [id], onDelete: Cascade)
  actorProfile   ActorProfile  @relation(fields: [actorProfileId], references: [id], onDelete: Cascade)

  @@unique([proId, actorProfileId])
}

model Message {
  id        String    @id @default(uuid())
  castingId String
  senderId  String
  content   String
  readAt    DateTime?
  createdAt DateTime  @default(now())
  casting   Casting   @relation(fields: [castingId], references: [id], onDelete: Cascade)
  sender    User      @relation("MessagesSent", fields: [senderId], references: [id], onDelete: Cascade)
}

model Article {
  id          String    @id @default(uuid())
  titre       String
  slug        String    @unique
  content     String
  categoryId  String?
  authorId    String
  seoMeta     Json?
  publishedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  author      User      @relation(fields: [authorId], references: [id])
}

model Film {
  id              String         @id @default(uuid())
  titre           String
  slug            String         @unique
  annee           Int
  synopsis        String
  affiche         String?
  realisateur     String
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  isPublished     Boolean        @default(false)
  trailerUrl      String?
  acteurs         ActorProfile[] @relation("FilmActors")
  equipeTechnique CrewProfile[]  @relation("FilmCrew")
}

model Course {
  id           String         @id @default(uuid())
  titre        String
  slug         String         @unique
  description  String
  thumbnail    String?
  price        Float?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  certificates Certificate[]
  modules      Module[]
  progress     UserProgress[]
}

model Module {
  id       String   @id @default(uuid())
  courseId String
  titre    String
  ordre    Int
  lessons  Lesson[]
  course   Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
}

model Lesson {
  id         String         @id @default(uuid())
  moduleId   String
  titre      String
  texte      String?
  videoId    String?
  ressources String[]
  ordre      Int
  module     Module         @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  quizzes    Quiz[]
  progress   UserProgress[]
}

model Quiz {
  id           String            @id @default(uuid())
  lessonId     String
  titre        String
  passingScore Int               @default(80)
  lesson       Lesson            @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  questions    QuizQuestion[]
  attempts     UserQuizAttempt[]
}

model QuizQuestion {
  id              String @id @default(uuid())
  quizId          String
  texte           String
  options         Json
  correctOptionId String
  quiz            Quiz   @relation(fields: [quizId], references: [id], onDelete: Cascade)
}

model UserQuizAttempt {
  id        String   @id @default(uuid())
  userId    String
  quizId    String
  score     Int
  passed    Boolean
  createdAt DateTime @default(now())
  quiz      Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model UserProgress {
  id          String    @id @default(uuid())
  userId      String
  courseId    String
  lessonId    String
  pourcentage Int       @default(0)
  completedAt DateTime?
  course      Course    @relation(fields: [courseId], references: [id], onDelete: Cascade)
  lesson      Lesson    @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
}

model Certificate {
  id       String   @id @default(uuid())
  userId   String
  courseId String
  uniqueId String   @unique
  pdfUrl   String?
  issuedAt DateTime @default(now())
  course   Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Payment {
  id          String          @id @default(uuid())
  userId      String
  provider    PaymentProvider
  amount      Float
  currency    String          @default("XOF")
  status      PaymentStatus   @default(PENDING)
  productType ProductType
  reference   String          @unique
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Subscription {
  id          String      @id @default(uuid())
  userId      String
  plan        ProductType
  validUntil  DateTime
  stripeSubId String?     @unique
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Notification {
  id        String    @id @default(uuid())
  userId    String
  type      String
  payload   Json
  readAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model AuditLog {
  id         String   @id @default(uuid())
  adminId    String
  action     String
  targetType String
  targetId   String
  metadata   Json?
  createdAt  DateTime @default(now())
  admin      User     @relation(fields: [adminId], references: [id], onDelete: Cascade)
}

enum Role {
  ACTOR
  PRO
  STUDENT
  ADMIN
  CREW
  AGENT
}

enum ProfileStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  REJECTED
}

enum ApplicationStatus {
  PENDING
  SHORTLISTED
  REJECTED
  ACCEPTED
}

enum CastingStatus {
  DRAFT
  PUBLISHED
  CLOSED
}

enum PaymentProvider {
  STRIPE
  WAVE
  ORANGE_MONEY
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum ProductType {
  ACTOR_PREMIUM
  PRO_SUBSCRIPTION
  ACADEMY_SUBSCRIPTION
  COURSE_ONE_TIME
  PROFILE_BOOST
}
